# IceMaker → Render Deployment Guide

This guide covers deploying IceMaker to Render with full production functionality.

## Architecture Summary

IceMaker is a **single Node.js web service** that:
- Serves the API (Express, `/api/*` routes)
- Serves the static frontend (Vite build, `/dist/public`)
- Uses PostgreSQL for data persistence
- Uses S3-compatible object storage for media files

**Deployment Model**: One Render Web Service + One Render PostgreSQL Database

---

## Quick Start (One-Click Deploy)

1. Push your code to a GitHub/GitLab repository
2. In Render Dashboard, click **New > Blueprint**
3. Connect your repository
4. Render will detect `render.yaml` and create:
   - Web service: `icemaker`
   - Database: `icemaker-db`
5. Configure the required environment variables (see below)
6. Deploy

---

## Environment Variables

### Required (Will Not Start Without These)

| Variable | Description | Example |
|----------|-------------|---------|
| `DATABASE_URL` | PostgreSQL connection string | Auto-set by Render from database |
| `PUBLIC_TOKEN_SECRET` | 32+ char secret for token signing | Auto-generated by Render |
| `SESSION_SECRET` | Session cookie secret | Auto-generated by Render |

### Required for Core Features

| Variable | Description | Where to Get |
|----------|-------------|--------------|
| `PUBLIC_APP_URL` | Your app's public URL | `https://icemaker.onrender.com` |
| `STRIPE_SECRET_KEY` | Stripe API secret key | [Stripe Dashboard](https://dashboard.stripe.com/apikeys) |
| `STRIPE_PUBLISHABLE_KEY` | Stripe publishable key | [Stripe Dashboard](https://dashboard.stripe.com/apikeys) |
| `STRIPE_WEBHOOK_SECRET` | Webhook signing secret | [Stripe Webhooks](https://dashboard.stripe.com/webhooks) |
| `OPENAI_API_KEY` | OpenAI API key | [OpenAI Platform](https://platform.openai.com/api-keys) |

### Required for Full Functionality

| Variable | Description | Where to Get |
|----------|-------------|--------------|
| `RESEND_API_KEY` | Email sending | [Resend Dashboard](https://resend.com/api-keys) |
| `EMAIL_FROM_ADDRESS` | Sender email | Your verified domain |
| `REPLICATE_API_TOKEN` | Video generation | [Replicate](https://replicate.com/account/api-tokens) |
| `KLING_ACCESS_KEY` | Premium video (optional) | Kling AI Dashboard |
| `KLING_SECRET_KEY` | Premium video (optional) | Kling AI Dashboard |

### Object Storage (Required for Media)

| Variable | Description |
|----------|-------------|
| `R2_ENDPOINT` | S3-compatible endpoint URL |
| `R2_ACCESS_KEY_ID` | Access key |
| `R2_SECRET_ACCESS_KEY` | Secret key |
| `R2_BUCKET` | Bucket name |
| `R2_PUBLIC_BASE_URL` | Public URL for serving files |

---

## Build & Start Commands

Already configured in `render.yaml`:

```yaml
buildCommand: npm install && npm run build
startCommand: npm run start
```

**What happens during build:**
1. `npm install` - Install dependencies
2. `npm run build` - Runs `script/build.ts`:
   - Vite builds frontend → `dist/public/`
   - esbuild bundles server → `dist/index.cjs`

**What happens on start:**
1. `npm run start` - Runs `NODE_ENV=production node dist/index.cjs`
2. Server binds to `0.0.0.0:$PORT`
3. Serves API routes and static frontend

---

## Database Setup

### Automatic (via render.yaml)

The `render.yaml` blueprint creates a PostgreSQL database and links it via `DATABASE_URL`.

### Manual Setup

1. Create a PostgreSQL database in Render
2. Copy the **Internal Connection String**
3. Set `DATABASE_URL` in your web service

### Migrations

IceMaker uses Drizzle ORM with auto-migration. Tables are created on first access.

For manual schema push:
```bash
DATABASE_URL="your-connection-string" npm run db:push
```

---

## Health Checks

Render will ping `/api/health` to verify the service is running.

**Expected response:**
```json
{
  "status": "healthy",
  "timestamp": "2024-01-15T10:30:00.000Z",
  "environment": "production"
}
```

If database is unreachable, returns 503 with:
```json
{
  "status": "unhealthy",
  "error": "Database connection failed"
}
```

---

## Stripe Webhook Configuration

1. Go to [Stripe Dashboard → Webhooks](https://dashboard.stripe.com/webhooks)
2. Click **Add endpoint**
3. Set URL: `https://your-app.onrender.com/api/stripe/webhook`
4. Select events:
   - `checkout.session.completed`
   - `customer.subscription.created`
   - `customer.subscription.updated`
   - `customer.subscription.deleted`
   - `invoice.paid`
   - `invoice.payment_failed`
5. Copy the **Signing secret** → Set as `STRIPE_WEBHOOK_SECRET`

---

## Object Storage Setup (Cloudflare R2 Example)

1. Create an R2 bucket in Cloudflare Dashboard
2. Create API token with R2 read/write permissions
3. Configure public access (either via Workers or Public Bucket URL)
4. Set environment variables:
   ```
   R2_ENDPOINT=https://your-account-id.r2.cloudflarestorage.com
   R2_ACCESS_KEY_ID=your-access-key
   R2_SECRET_ACCESS_KEY=your-secret-key
   R2_BUCKET=icemaker-assets
   R2_PUBLIC_BASE_URL=https://assets.yourdomain.com
   ```

---

## Troubleshooting

### App won't start

1. Check logs: Render Dashboard → Logs
2. Look for `SECURITY CHECKS FAILED` message
3. Ensure `DATABASE_URL` and `PUBLIC_TOKEN_SECRET` are set

### Database connection fails

1. Verify database is running in Render
2. Check `DATABASE_URL` is correctly linked
3. Try Internal vs External connection string

### Static files not loading

1. Check build completed successfully
2. Verify `dist/public/` was created
3. Check no 404s in browser console

### Webhooks not working

1. Verify webhook URL matches exactly
2. Check `STRIPE_WEBHOOK_SECRET` is set
3. Test with Stripe CLI: `stripe listen --forward-to localhost:5000/api/stripe/webhook`

---

## Production Checklist

- [ ] `DATABASE_URL` set (auto from Render DB)
- [ ] `PUBLIC_TOKEN_SECRET` set (auto-generated)
- [ ] `SESSION_SECRET` set (auto-generated)
- [ ] `PUBLIC_APP_URL` set to your domain
- [ ] `STRIPE_*` keys configured
- [ ] `OPENAI_API_KEY` set
- [ ] Stripe webhook created and verified
- [ ] Object storage configured (if using media features)
- [ ] Custom domain configured (optional)
- [ ] SSL verified (automatic on Render)

---

## Performance Notes

- **Cold start**: ~3-5 seconds (esbuild bundled server)
- **Memory**: Starter plan (512MB) is sufficient for moderate traffic
- **Database**: Starter plan handles 97 connections

For high traffic, upgrade to Standard plan for zero-downtime deploys.
